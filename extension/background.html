<html>
<head>
<script src="lib/3rdparty/jquery-1.5.1.min.js"></script>
<script src="js/analytics.js"></script>
</head>
<body>

<script type="text/javascript">
	// Global accessor that the popup uses.
	var selectedTabId = null;
	var selectedWindowId = null;

	console.log('background.html');

	chrome.browserAction.onClicked.addListener(function(tab) {
		
		if (selectedTabId != null) {
			chrome.tabs.remove(selectedTabId);
			selectedTabId = null;
		}
		
		if (selectedTabId == null) {
		     chrome.tabs.create({'url': 'showmanager.html'},openExtensionManager);
		} else {
			chrome.tabs.update(selectedTabId, {
				selected : true
			},refreshExtensionManager);
		}

	});

	function refreshExtensionManager(tab){
		selectedTabId = tab.id;
		console.log('openExtensionManager');
		console.log(tab);
		
	};
	
	function openExtensionManager(tab) {
		selectedTabId = tab.id;
		console.log('openExtensionManager');
		console.log(tab);

	};

	chrome.management.getAll(function(extensionInfos) {
		console.log(extensionInfos);
		for ( var extensionInfo in extensionInfos) {
			if (extensionInfo.enabled) {

				$('#extensions').append(
						'<div>' + extensionInfo.isApp + '</div>' + '<div>'
								+ extensionInfo.id + '</div>' + '<div>'
								+ extensionInfo.name + '</div>' + '<div>'
								+ extensionInfo.description + '</div>');

			}
		}
	});

	/*
	chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
		console.log('extension.onRequest');
		
		if (request.action == 'fetchTabInfo') {
			fetchTabInfo(sendResponse);
		}
		
	});
	 */

	function fetchTabInfo(callback) {

		chrome.tabs.get(selectedTabId, function(tab) {
			console.log('chrome.tabs.getCurrent:');
			console.log(tab);

			/*
			 * check if we are in the market
			 */
			var result = tab.url.search(/market.android.com/);
			if (result != -1) {
				updateQRCode(tab.id, tab.url)
			}

		});

	}

	/*
	chrome.tabs.onUpdated.addListener(function(tabId, change, tab) {
		if (change.status == "complete") {
			console.log('backgrounds.tabs.onUpdated');
			updateQRCode(tab.id, tab.url);
		}
	});
	 */

	function updateQRCode(tabId, tabUrl) {
		console.log('updateQRCode(' + tabId + ':' + tabUrl + ')');
		selectedPacketName = null;

		console.log('tabs.sendRequest');

		var splitted = tabUrl.split('id=', 3);

		if (splitted != undefined && splitted.length >= 1) {

			selectedPacketName = splitted[1];

			chrome.pageAction.setTitle({
				tabId : tabId,
				title : selectedPacketName
			});

			chrome.pageAction.show(tabId);
		} else {
			chrome.pageAction.hide(tabId);
		}

	}

	/*
	chrome.tabs.onSelectionChanged.addListener(function(tabId, selectInfo) {
	console.log('chrome.tabs.onSelectionChanged.addListener');
	
	selectedTabId = tabId;
	selectedWindowId = selectInfo;
	fetchTabInfo();
	});
	 */
</script>

<div id="extensions"></div>


</body>
</html>